version: 0.2

phases:
  install:
    commands:
      - echo "Install JDK 17 & Maven if needed"
      - yum -y install java-17-amazon-corretto-headless maven || (apt-get update && apt-get -y install openjdk-17-jdk maven)
  build:
    commands:
      - |
        # 프로젝트 위치 자동 감지
        if [ -f pom.xml ]; then
          PROJECT_DIR=.
        elif [ -f app/pom.xml ]; then
          PROJECT_DIR=app
        else
          echo "No pom.xml found"; exit 1
        fi
        echo "Using project dir: $PROJECT_DIR"
        mvn -f "$PROJECT_DIR/pom.xml" -B -DskipTests clean package
        export JAR_DIR="$PROJECT_DIR/target"
  post_build:
    commands:
      - echo "Bundle artifacts for CodeDeploy"
      - mkdir -p artifact/app/build/libs artifact/app/public
      - cp ${JAR_DIR}/*.jar artifact/app/build/libs/app.jar
      - cp -r appspec.yml scripts systemd artifact/
      - printf '{"commit":"%s","builtAt":"%s"}' "$CODEBUILD_RESOLVED_SOURCE_VERSION" "$(date -u +%FT%TZ)" > artifact/app/public/build.json

artifacts:
  files:
    - appspec.yml
    - scripts/**/*
    - systemd/**/*
    - app/build/libs/app.jar
    - app/public/build.json
  base-directory: artifact
